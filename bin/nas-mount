#!/bin/zsh
#
# nas-mount - Mount NAS cache share via SMB (silent, no Finder popup)
#
# Uses settings from config.sh and macOS Keychain for authentication.
# First mount via Finder (Cmd+K, smb://...) to save credentials to Keychain.
#

SCRIPT_DIR="${0:A:h}"
source "$SCRIPT_DIR/../config.sh"

# Check if already mounted
if mount | grep -q "$NAS_MOUNT_POINT"; then
    echo "NAS already mounted at $NAS_MOUNT_POINT"
    exit 0
fi

# Check if NAS is reachable
if ! ping -c 1 -W 2 "$NAS_IP" &>/dev/null; then
    echo "NAS not reachable at $NAS_IP"
    exit 1
fi

# Create mount point if needed
if [ ! -d "$NAS_MOUNT_POINT" ]; then
    echo "Creating mount point: $NAS_MOUNT_POINT"
    sudo mkdir -p "$NAS_MOUNT_POINT"
fi

echo "Mounting NAS..."

# Use mount_smbfs with Keychain credentials (-N flag)
# Credentials are stored in Keychain from first Finder mount
/sbin/mount_smbfs -N "//${NAS_USER}@${NAS_IP}/${NAS_SMB_SHARE}" "$NAS_MOUNT_POINT" 2>&1

if mount | grep -q "$NAS_MOUNT_POINT"; then
    echo "Mounted successfully at $NAS_MOUNT_POINT"
    exit 0
else
    echo "Mount failed - ensure credentials are in Keychain (mount via Finder first)"
    exit 1
fi
