#!/bin/zsh
# Mount NAS cache share via SMB
#
# Uses settings from config.sh and macOS Keychain for authentication
# First mount via Finder (Cmd+K, smb://...) to save credentials to Keychain

SCRIPT_DIR="${0:A:h}"
source "$SCRIPT_DIR/../config.sh"

# Check if already mounted
if mount | grep -q "$NAS_MOUNT_POINT"; then
    echo "NAS already mounted at $NAS_MOUNT_POINT"
    exit 0
fi

# Check if NAS is reachable
if ! ping -c 1 -W 2 "$NAS_IP" &>/dev/null; then
    echo "NAS not reachable at $NAS_IP"
    exit 1
fi

# Mount using Finder/Keychain (credentials stored from first manual mount)
echo "Mounting NAS..."
open "smb://${NAS_USER}@${NAS_IP}/${NAS_SMB_SHARE}"

# Wait for mount to complete (up to 10 seconds)
for i in {1..10}; do
    sleep 1
    if mount | grep -q "$NAS_MOUNT_POINT"; then
        echo "Mounted successfully at $NAS_MOUNT_POINT"
        exit 0
    fi
done

echo "Mount timed out - check Finder for authentication prompt"
exit 1
